let c=!1,s=null,d=[],l=[];const p=new URLSearchParams(window.location.search),u=p.get("id");u&&(c=!0,s=u,document.getElementById("page-title").textContent="Modifica Prodotto");async function E(){try{const e=await fetch("/api/catalog/categories",{credentials:"include"});if(!e.ok)throw new Error("Failed to load categories");const t=await e.json();if(t.success){const n=["immagine","sicurezza","e6nbi7xju9xa5rnz5p9sjwgl","sxrgfywyk7ac25hch1r4ppzl"];d=t.data.filter(o=>n.includes(o.id)),console.log("âœ… Categorie principali caricate per admin:",d.length,d.map(o=>o.name)),v()}}catch(e){console.error("Error loading categories:",e)}}async function y(e){try{const t=await fetch(`/api/catalog/categories/${e}/subcategories`,{credentials:"include"});if(!t.ok)throw new Error("Failed to load subcategories");const n=await t.json();n.success&&(l=n.data,h())}catch(t){console.error("Error loading subcategories:",t)}}function v(){const e=document.getElementById("category_id");e.innerHTML='<option value="">Seleziona categoria...</option>',d.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)})}function h(){const e=document.getElementById("subcategory_id");e.innerHTML='<option value="">Seleziona sottocategoria...</option>',e.disabled=l.length===0,l.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)})}async function g(e){const t=document.getElementById("loading-state"),n=document.getElementById("error-state"),o=document.getElementById("product-form");t.classList.remove("hidden"),n.classList.add("hidden"),o.classList.add("hidden");try{const r=await fetch(`/api/admin/products/${e}`,{credentials:"include"});if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const a=await r.json();if(a.success&&a.data)I(a.data),t.classList.add("hidden"),o.classList.remove("hidden");else throw new Error("Invalid response format")}catch(r){console.error("Error loading product:",r);const a=r instanceof Error?r.message:"Unknown error";document.getElementById("error-message").textContent=a,t.classList.add("hidden"),n.classList.remove("hidden")}}function I(e){document.getElementById("name").value=e.name||"",document.getElementById("slug").value=e.slug||"",document.getElementById("short_description").value=e.short_description||"",document.getElementById("description").value=e.description||"",document.getElementById("price").value=e.price||"",document.getElementById("price_range").value=e.price_range||"",document.getElementById("features").value=Array.isArray(e.features)?e.features.join(`
`):e.features||"",document.getElementById("images").value=Array.isArray(e.images)?e.images.join(`
`):e.images||"",document.getElementById("status").value=e.status||"active",document.getElementById("badge").value=e.badge||"",document.getElementById("featured").checked=e.featured||!1,document.getElementById("referenti").value=e.referenti||"",e.category_id&&(document.getElementById("category_id").value=e.category_id,y(e.category_id).then(()=>{e.subcategory_id&&(document.getElementById("subcategory_id").value=e.subcategory_id)}))}function B(e){return e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim()}async function m(e=!1){const t=new FormData(document.getElementById("product-form")),n={name:t.get("name")||"",slug:t.get("slug")||"",description:t.get("description")||"",short_description:t.get("short_description")||null,category_id:t.get("category_id")||"",subcategory_id:t.get("subcategory_id")||"",price:t.get("price")?t.get("price"):null,price_range:t.get("price_range")||null,badge:t.get("badge")||null,featured:t.has("featured"),referenti:t.get("referenti")||null,status:e?"draft":t.get("status")||"active"},o=t.get("features");o&&(n.features=o.split(`
`).filter(a=>a.trim()));const r=t.get("images");r&&(n.images=r.split(`
`).filter(a=>a.trim()));try{let a;if(c&&s?a=await fetch(`/api/admin/products/${s}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)}):a=await fetch("/api/admin/products",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)}),!a.ok){const f=await a.text();throw console.error("Response error:",f),new Error(`HTTP ${a.status}: ${a.statusText}`)}const i=await a.json();i.success?(alert(i.message||"Prodotto salvato con successo!"),window.location.href="/admin/products"):alert(`Errore: ${i.error||"Errore sconosciuto"}`)}catch(a){console.error("Error saving product:",a);const i=a instanceof Error?a.message:"Unknown error";alert(`Errore nel salvataggio: ${i}`)}}document.addEventListener("DOMContentLoaded",async()=>{await E(),c&&s?await g(s):(document.getElementById("loading-state").classList.add("hidden"),document.getElementById("product-form").classList.remove("hidden")),document.getElementById("name").addEventListener("input",e=>{const t=e.target.value,n=document.getElementById("slug");(!n.value||n.dataset.autoGenerated==="true")&&(n.value=B(t),n.dataset.autoGenerated="true")}),document.getElementById("slug").addEventListener("input",()=>{const e=document.getElementById("slug");e.dataset.autoGenerated="false"}),document.getElementById("category_id").addEventListener("change",e=>{const t=e.target.value;if(t)y(t);else{const n=document.getElementById("subcategory_id");n.innerHTML='<option value="">Seleziona prima una categoria...</option>',n.disabled=!0}}),document.getElementById("product-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("save-btn"),n=document.getElementById("save-btn-text"),o=document.getElementById("save-btn-loading");t.setAttribute("disabled","true"),n.classList.add("hidden"),o.classList.remove("hidden");try{await m(!1)}finally{t.removeAttribute("disabled"),n.classList.remove("hidden"),o.classList.add("hidden")}}),document.getElementById("save-draft-btn").addEventListener("click",()=>{m(!0)}),document.getElementById("cancel-btn").addEventListener("click",()=>{confirm("Sei sicuro di voler annullare? Le modifiche non salvate andranno perse.")&&(window.location.href="/admin/products")}),document.getElementById("retry-btn").addEventListener("click",()=>{c&&s&&g(s)})});
