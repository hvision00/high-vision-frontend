let l=[],m=[],o=null,i=null;async function p(){try{const t=await fetch("/api/catalog/categories",{credentials:"include"});if(!t.ok)throw new Error("Failed to load categories");const e=await t.json();if(e.success){const n=["immagine","sicurezza","e6nbi7xju9xa5rnz5p9sjwgl","sxrgfywyk7ac25hch1r4ppzl"];m=e.data.filter(a=>n.includes(a.id)),E()}}catch(t){console.error("Error loading categories:",t)}}function E(){const t=document.getElementById("category-filter"),e=document.getElementById("category_id");t.innerHTML='<option value="">Tutte le categorie</option>',e.innerHTML='<option value="">Seleziona categoria...</option>',m.forEach(n=>{const a=document.createElement("option");a.value=n.id,a.textContent=n.name,t.appendChild(a);const s=document.createElement("option");s.value=n.id,s.textContent=n.name,e.appendChild(s)})}async function c(t=""){const e=document.getElementById("loading-state"),n=document.getElementById("error-state"),a=document.getElementById("table-container"),s=document.getElementById("empty-state");e.classList.remove("hidden"),n.classList.add("hidden"),a.classList.add("hidden"),s.classList.add("hidden");try{const r=t?`/api/admin/subcategories?category=${t}`:"/api/admin/subcategories",d=await fetch(r,{credentials:"include"});if(!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);const u=await d.json();if(u.success)l=u.data,l.length===0?(e.classList.add("hidden"),s.classList.remove("hidden")):(v(),e.classList.add("hidden"),a.classList.remove("hidden"));else throw new Error("Invalid response format")}catch(r){console.error("Error loading subcategories:",r);const d=r instanceof Error?r.message:"Unknown error";document.getElementById("error-message").textContent=d,e.classList.add("hidden"),n.classList.remove("hidden")}}function v(){const t=document.getElementById("subcategories-table-body");t.innerHTML="",l.forEach(e=>{const n=document.createElement("tr");n.className="hover:bg-gray-50 transition-colors";const a=e.status==="active"?'<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">Attivo</span>':'<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-medium">Inattivo</span>',s=new Date(e.created_at).toLocaleDateString("it-IT");n.innerHTML=`
          <td class="px-6 py-4">
            <div class="font-semibold text-gray-900">${e.name}</div>
            ${e.description?`<div class="text-sm text-gray-500">${e.description}</div>`:""}
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-gray-900">${e.category_name||"N/A"}</div>
          </td>
          <td class="px-6 py-4">
            <code class="text-sm bg-gray-100 px-2 py-1 rounded">${e.slug}</code>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-gray-900">${e.product_count||0} prodotti</div>
          </td>
          <td class="px-6 py-4">${a}</td>
          <td class="px-6 py-4">
            <div class="text-sm text-gray-500">${s}</div>
          </td>
          <td class="px-6 py-4 text-right">
            <div class="flex items-center justify-end space-x-2">
              <button onclick="editSubcategory('${e.id}')" class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
              <button onclick="deleteSubcategory('${e.id}', '${e.name}')" class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </td>
        `,t.appendChild(n)})}function f(){o=null,document.getElementById("modal-title").textContent="Nuova Sottocategoria",document.getElementById("submit-text").textContent="Crea Sottocategoria",document.getElementById("subcategory-form").reset(),document.getElementById("subcategory-modal").classList.remove("hidden")}function h(t){o=l.find(e=>e.id===t),o&&(document.getElementById("modal-title").textContent="Modifica Sottocategoria",document.getElementById("submit-text").textContent="Aggiorna Sottocategoria",document.getElementById("name").value=o.name,document.getElementById("category_id").value=o.category_id,document.getElementById("slug").value=o.slug,document.getElementById("description").value=o.description||"",document.getElementById("sort_order").value=o.sort_order||0,document.getElementById("subcategory-modal").classList.remove("hidden"))}function g(){document.getElementById("subcategory-modal").classList.add("hidden"),o=null}function x(t,e){i=t,document.getElementById("delete-subcategory-name").textContent=e,document.getElementById("delete-modal").classList.remove("hidden")}function y(){document.getElementById("delete-modal").classList.add("hidden"),i=null}function b(t){return t.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim()}async function I(t){try{const e=o?`/api/admin/subcategories/${o.id}`:"/api/admin/subcategories",s=await(await fetch(e,{method:o?"PUT":"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)})).json();s.success?(alert(o?"Sottocategoria aggiornata con successo!":"Sottocategoria creata con successo!"),g(),c()):alert(`Errore: ${s.error||"Errore sconosciuto"}`)}catch(e){console.error("Error saving subcategory:",e),alert(`Errore nel salvataggio: ${e.message}`)}}async function B(){if(i)try{const e=await(await fetch(`/api/admin/subcategories/${i}`,{method:"DELETE",credentials:"include"})).json();e.success?(alert("Sottocategoria eliminata con successo!"),y(),c()):alert(`Errore nell'eliminazione: ${e.error||"Errore sconosciuto"}`)}catch(t){console.error("Error deleting subcategory:",t),alert(`Errore nell'eliminazione: ${t.message}`)}}document.addEventListener("DOMContentLoaded",async()=>{await p(),await c(),document.getElementById("name").addEventListener("input",t=>{const e=t.target.value,n=document.getElementById("slug");n.dataset.manuallyEdited||(n.value=b(e))}),document.getElementById("slug").addEventListener("input",()=>{document.getElementById("slug").dataset.manuallyEdited="true"}),document.getElementById("subcategory-form").addEventListener("submit",async t=>{t.preventDefault();const e={name:document.getElementById("name").value,category_id:document.getElementById("category_id").value,slug:document.getElementById("slug").value,description:document.getElementById("description").value||null,sort_order:parseInt(document.getElementById("sort_order").value)||0,status:"active"};await I(e)}),document.getElementById("filter-btn").addEventListener("click",()=>{const t=document.getElementById("category-filter").value;c(t)}),document.getElementById("retry-btn").addEventListener("click",()=>{c()}),document.getElementById("confirm-delete-btn").addEventListener("click",B)});window.openCreateModal=f;window.editSubcategory=h;window.deleteSubcategory=x;window.closeModal=g;window.closeDeleteModal=y;
